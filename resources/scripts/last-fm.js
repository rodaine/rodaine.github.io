// Generated by CoffeeScript 1.6.1
(function(){define(["underscore","jquery","json2"],function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;S="http://ws.audioscrobbler.com/2.0/";c={limit:1,user:"rodaine",api_key:"96d7c9d5b70ab2fbfccd635f690c489d",method:"user.getrecenttracks",format:"json"};d=6e4;r=t(document);o=!0;i=void 0;l=[];w=function(e){return e&&typeof e=="object"&&e instanceof Array&&typeof e.length=="number"&&typeof e.splice=="function"&&!e.propertyIsEnumerable("length")};a=(typeof window!=="undefined"&&window!==null?window.localStorage:void 0)!=null;f="lastfm"+c.api_key+c.method+c.user;u=function(){return a?n.parse(localStorage.getItem(f)):null};g=function(e){return a?localStorage.setItem(f,n.stringify(e)):null};p=void 0;y=function(){if(p!=null)return;v();return p=setInterval(v,d)};b=function(){clearInterval(p);return p=void 0};v=function(){return r.trigger("lastFM.poll")};h=function(t){var n,r,i,s,o,u,a;if((t!=null?t.recenttracks:void 0)==null)return!1;n=t.recenttracks.track;w(n)&&(n=e.last(n));return n==null?!1:r={timestamp:(i=parseInt(n.date.uts,10))!=null?i:0,artist:(s=n.artist["#text"])!=null?s:"Unknown Artist",track:(o=n.name)!=null?o:"Unknown Track",url:(u=n.url)!=null?u:"http:///www.last.fm",image:(a=n.image[1]["#text"])!=null?a:"http://placehold.it/64&text=last.fm"}};E=function(e,t,n){var o;o=h(e);if(!o)return s(n,t,"unable to parse track");i=o;return r.trigger("lastFM.track_recieved")};s=function(e,t,n){console.log("Failed to get track: "+n);b();return r.trigger("lastFM.failure")};m=function(){return t.ajax(S,{cache:!1,data:c,dataType:"json",success:E,error:s})};r.bind("lastFM.poll",function(){var e;if(o&&(e=u())){i=e;r.trigger("lastFM.track_recieved")}o=!1;return m()});r.bind("lastFM.track_recieved",function(){var e,t,n,r;g(i);r=[];for(t=0,n=l.length;t<n;t++){e=l[t];r.push(listener.trigger("lastFM.track_updated",i))}return r});t.fn.lastFM=function(e){var n;n=t(this);n.on("lastFM.track_updated",e);y();return this};return t})}).call(this);