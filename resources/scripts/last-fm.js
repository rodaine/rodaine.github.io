// Generated by CoffeeScript 1.6.1
(function(){define(["underscore","jquery","json2"],function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;E="http://ws.audioscrobbler.com/2.0/";l={limit:1,user:"rodaine",api_key:"96d7c9d5b70ab2fbfccd635f690c489d",method:"user.getrecenttracks",format:"json"};p=6e4;r=t(document);i=void 0;f=[];b=function(e){return e&&typeof e=="object"&&e instanceof Array&&typeof e.length=="number"&&typeof e.splice=="function"&&!e.propertyIsEnumerable("length")};u=(typeof window!=="undefined"&&window!==null?window.localStorage:void 0)!=null;a="lastfm"+l.api_key+l.method+l.user;o=function(){return u?n.parse(localStorage.getItem(a)):null};m=function(e){return u?localStorage.setItem(a,n.stringify(e)):null};h=void 0;g=function(){if(h!=null)return;d();return h=setInterval(d,p)};y=function(){clearInterval(h);return h=void 0};d=function(){return r.trigger("lastFM.poll")};c=function(t){var n,r,i,s,o,u,a;if((t!=null?t.recenttracks:void 0)==null)return!1;n=t.recenttracks.track;b(n)&&(n=e.last(n));if(n==null)return!1;r={timestamp:(i=parseInt(n.date.uts,10))!=null?i:0,artist:(s=n.artist["#text"])!=null?s:"Unknown Artist",track:(o=n.name)!=null?o:"Unknown Track",url:(u=n.url)!=null?u:"http:///www.last.fm",image:(a=n.image[1]["#text"])!=null?a:"http://placehold.it/64&text=last.fm"};r.image||(r.image="http://placehold.it/64&text=last.fm");return r};w=function(e,t,n){var o;o=c(e);if(!o)return s(n,t,"unable to parse track");i=o;return r.trigger("lastFM.track_recieved")};s=function(e,t,n){console.log("Failed to get track: "+n);y();i==null&&(i=o());if(i!=null)return r.trigger("lastFM.track_recieved")};v=function(){return t.ajax(E,{cache:!1,data:l,dataType:"json",success:w,error:s,timeout:.75*p})};r.bind("lastFM.poll",function(){return v()});r.bind("lastFM.track_recieved",function(){var e,t,n,r;m(i);r=[];for(t=0,n=f.length;t<n;t++){e=f[t];r.push(e.trigger("lastFM.track_updated",i))}return r});t.fn.lastFM=function(e){var n;n=t(this);n.on("lastFM.track_updated",e);f.push(n);g();return this};return t})}).call(this);